# 实时测试指南
## Real-time Testing Guide

本指南说明如何使用访问控制系统的实时模拟功能进行测试。

---

## 📋 前置条件

### 1. 数据库准备
确保数据库已正确设置并包含测试数据：
- 用户数据（Users）
- 徽章数据（Badges）
- 资源数据（Resources）
- 配置文件数据（Profiles）
- 资源组数据（ResourceGroups）
- 访问规则数据（AccessRules）

### 2. 启动应用
```bash
# 编译项目
mvn clean package

# 运行应用
java -jar target/access-control-system-1.0.0.jar
```

---

## 🚀 实时模拟测试步骤

### 步骤 1: 进入监控面板
1. 启动应用后，点击顶部标签页 **"Real-time Monitoring"**
2. 系统会自动初始化内存缓存（从数据库加载所有数据）
3. 如果缓存初始化成功，控制台会显示加载的数据统计信息

### 步骤 2: 手动测试（可选）
在开始实时模拟前，可以先进行手动测试：

#### 2.1 单次访问测试
- 在 **"Badge ID"** 输入框中输入徽章ID（例如：`BX76Z541`）
- 在 **"Resource ID"** 输入框中输入资源ID（例如：`RES001`）
- 点击 **"Simulate Access"** 按钮
- 查看 **"Activity Log"** 区域的结果

#### 2.2 快速测试
- 点击 **"Quick Test"** 按钮
- 系统会自动执行4个预设测试用例：
  1. 有效徽章访问主入口
  2. 有效徽章访问办公室
  3. 无效徽章测试
  4. 不存在的资源测试

### 步骤 3: 启动实时模拟
1. 点击 **"Start Real-time Simulation"** 按钮
2. 按钮文字会变为 **"Stop Real-time Simulation"**
3. 系统开始自动模拟访问请求

### 步骤 4: 观察实时模拟
实时模拟会执行以下操作：

#### 4.1 访问模式
- **频率**: 每 3 秒执行一次访问请求
- **选择方式**: 随机选择一个活跃的徽章（Badge）和随机选择一个资源（Resource）
- **自动执行**: 无需人工干预

#### 4.2 访问结果
在 **"Activity Log"** 区域可以看到：
- ✓ 绿色对勾：访问成功（Granted）
- ✗ 红色叉号：访问被拒绝（Denied）
- 每条记录包含：
  - 时间戳
  - 徽章ID
  - 资源ID
  - 访问状态
  - 拒绝原因（如果被拒绝）

#### 4.3 Reader锁定机制
当访问成功时：
1. **立即锁定**: 该资源的Badge Reader会立即被锁定
2. **锁定期间**: 在接下来的2秒内，该资源无法被访问
3. **锁定提示**: 尝试访问被锁定的资源会显示 "Reader is locked (door opened, please wait)"
4. **自动解锁**: 2秒后，Reader自动解锁，可以再次访问
5. **解锁通知**: 日志中会显示 "Reader for Resource XXX is now active again"

### 步骤 5: 停止实时模拟
- 点击 **"Stop Real-time Simulation"** 按钮
- 模拟会立即停止
- 日志会显示 "Real-time Simulation Stopped"

---

## 📊 测试场景说明

### 场景 1: 正常访问
- **条件**: 徽章有效、未过期、有权限访问资源
- **结果**: ✓ Access granted
- **后续**: Reader锁定2秒

### 场景 2: 无效徽章
- **条件**: 徽章不存在、已过期或未激活
- **结果**: ✗ Invalid badge
- **后续**: Reader不锁定

### 场景 3: 权限不足
- **条件**: 徽章有效，但没有访问该资源的权限
- **结果**: ✗ Insufficient access rights
- **后续**: Reader不锁定

### 场景 4: Reader已锁定
- **条件**: 资源刚刚被成功访问，Reader处于锁定状态
- **结果**: ✗ Reader is locked (door opened, please wait)
- **后续**: 等待2秒后自动解锁

### 场景 5: 资源不存在
- **条件**: 访问的资源ID在系统中不存在
- **结果**: ✗ Resource does not exist
- **后续**: Reader不锁定

---

## 🔍 观察要点

### 1. 日志输出
- 观察访问请求的频率（每3秒一次）
- 检查访问成功和失败的分布
- 验证Reader锁定和解锁的时间间隔（2秒）

### 2. 性能表现
- **零数据库查询**: 所有访问控制判断都在内存中完成
- **快速响应**: 访问请求处理时间应该在毫秒级
- **无延迟**: 不会因为数据库查询导致延迟

### 3. 并发行为
- 观察多个资源同时被访问的情况
- 验证Reader锁定机制是否正确工作
- 检查是否有资源在锁定期间被错误地允许访问

---

## 🛠️ 测试数据建议

### 推荐的测试数据配置

#### 活跃徽章（用于随机选择）
确保数据库中有多个活跃且未过期的徽章：
```sql
SELECT badge_id FROM badges 
WHERE is_active = TRUE 
AND expiration_date > CURDATE();
```

#### 资源列表
确保有多个不同类型的资源：
- 门（DOOR）
- 电梯（ELEVATOR）
- 打印机（PRINTER）
- 饮料机（BEVERAGE_DISPENSER）

#### 权限配置
- 部分徽章有权限访问部分资源
- 部分徽章没有权限访问某些资源
- 这样可以测试权限验证逻辑

---

## ⚠️ 注意事项

1. **缓存初始化**: 首次进入监控面板时，缓存会自动初始化。如果初始化失败，实时模拟将无法启动。

2. **数据同步**: 实时模拟使用的是启动时加载的缓存数据。如果在模拟过程中修改了数据库，需要重启应用才能看到更改。

3. **线程管理**: 实时模拟使用后台线程执行。关闭应用时会自动清理所有线程。

4. **日志文件**: 所有访问请求都会记录到日志文件中（`logs/YYYY/MM/YYYY-MM-DD.csv`），即使使用缓存模式。

---

## 🐛 故障排除

### 问题 1: 缓存初始化失败
**症状**: 启动实时模拟时提示 "Cache is not initialized"

**解决方案**:
- 检查数据库连接配置（`src/main/resources/config/database.properties`）
- 确保数据库服务正在运行
- 检查数据库是否包含必要的测试数据

### 问题 2: 没有活跃的徽章
**症状**: 启动实时模拟时提示 "No active badges or resources found"

**解决方案**:
- 在数据库中创建活跃的徽章
- 确保徽章的 `is_active = TRUE`
- 确保徽章的 `expiration_date > 当前日期`

### 问题 3: 所有访问都被拒绝
**可能原因**:
- 徽章没有关联的Profile
- Profile没有关联的ResourceGroup
- ResourceGroup中没有包含要访问的资源

**解决方案**:
- 检查徽章-Profile关联（`badge_profiles` 表）
- 检查Profile-ResourceGroup关联（`profile_resource_groups` 表）
- 检查ResourceGroup-Resource关联（`resource_group_members` 表）

---

## 📝 测试检查清单

- [ ] 数据库已正确设置并包含测试数据
- [ ] 应用成功启动
- [ ] 缓存初始化成功（查看控制台输出）
- [ ] 手动测试功能正常
- [ ] 实时模拟可以启动
- [ ] 访问请求每3秒执行一次
- [ ] 访问成功时Reader正确锁定
- [ ] Reader在2秒后自动解锁
- [ ] 日志正确显示所有访问记录
- [ ] 可以正常停止实时模拟

---

## 🎯 测试目标

通过实时模拟测试，验证以下功能：

1. ✅ **缓存机制**: 访问控制不查询数据库
2. ✅ **权限验证**: 正确判断徽章是否有权限访问资源
3. ✅ **Reader锁定**: 访问成功后正确锁定Reader
4. ✅ **自动解锁**: Reader在2秒后自动解锁
5. ✅ **随机访问**: 随机选择徽章和资源进行测试
6. ✅ **日志记录**: 所有访问请求都被正确记录
7. ✅ **性能表现**: 快速响应，无延迟

---

**测试完成后，记得停止实时模拟并关闭应用！**

